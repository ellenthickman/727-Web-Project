---
title: "727 Web Project"
subtitle: "Local Food Chains and Country Health Outcomes"
author: "Ellen Hickman"
date: "Fall 2025"
output: html_document
---

```{r}
library(xml2)
library(tidyverse)
library(dplyr)
library(rvest)
library(robotstxt)
library(httr)
library(jsonlite)
library(FAOSTAT) # package for FAO Data (local food chain indicator made from Self-Sufficiency inputs)
library(wbstats) # package for World Bank Data
library(WDI)
library(countrycode) # for linking datasets
```

# 1A. Get FAO Data (Self-Sufficiency inputs)
# Domain 'FBS' = Food Balance Sheets
```{r}
fao_data <- get_faostat_bulk("FBS") 
glimpse(fao_data)
options(scipen = 999)
```

### World Bank Country Codes
```{r}
# Remove non-countries with WB look-up table
library(readr)
country_codes <- read_csv("~/Desktop/727/727 Web Project/wb_countrycodes.csv") %>%
  mutate(
    area_code = sprintf("%03d", Code)
  ) %>%
  select(-Code) %>%
  relocate(area_code)
country_codes
```

```{r}
table(fao_data$element)
table(fao_data$element_code)
area_cts = table(fao_data$area)

fao_data_c <- fao_data %>%
  mutate(
    area_code = area_code__m49_ %>%
      gsub("^'", "", .) %>%       # remove leading apostrophe
      as.integer() %>%
      sprintf("%03d", .)          # pad to 3 digits
  ) %>%
  filter(
    area_code %in% country_codes$area_code,
    year == 2021,
    item == "Wheat and products",
    element %in% c("production", "import_quantity", "export_quantity")) %>%
  select(area_code, area, value, element)
fao_data_c
```
## 1B. Clean Data
```{r}
# Convert to wide format
fao_data_c_w <- pivot_wider(fao_data_c, names_from = element, values_from = value)  %>%
  left_join(country_codes, by = "area_code")
fao_data_c_w 
```



## 1C. Food Self-Sufficiency Ratio (SSR)
# Domestic Production / Domestic Consumption
# SSR = (Production / (Production + Imports - Exports))
```{r}
# SSR > 100%: Net Exporter (Globalized Provider). The country produces more than it eats (e.g., Brazil with Soy).
# SSR < 100%: Import Dependent (Globalized Consumer). The country relies on global chains to eat (e.g., Japan, UK).
# SSR â‰ˆ 100%: Self-Sufficient (Local). The country eats what it grows (e.g., Guyana, India for certain grains).

fao_data_c_w$ssr <- fao_data_c_w$production/(fao_data_c_w$production + fao_data_c_w$import_quantity - fao_data_c_w$export_quantity)

fao_data_c_w_ssr <- fao_data_c_w %>% 
  mutate(
    ssr = round((production / (production + import_quantity - export_quantity)) * 100,2)
  )
fao_data_c_w_ssr
```
## Dependent Variables
# 4. Fetch World Bank Data (Gini coefficient)
```{r}
# wb_cachelist <- wb_cache()
# str(wb_cachelist, max.level = 1)

gini_data <- wb_data(
  indicator = "SI.POV.GINI",
  country = "all",
  return_wide = TRUE
) %>%
  select(country, iso3c, date, Gini_Index = SI.POV.GINI) %>%
  filter(
     iso3c %in% country_codes$ISO3,
     date %in% c(2021)
  )
gini_data

# Missingness by (year) for years 2000-2023
# gini_na_year = gini_data %>%
#   group_by(date) %>%
#   summarise(
#     na_ct_year   = sum(is.na(Gini_Index)),
#     total_n_year = n(),                      # group-specific N
#     na_pct_year  = na_ct_year / total_n_year * 100,
#     sample_n_year = n() - na_ct_year
#   )
library(ggplot2)
library(dplyr)

# assuming your tibble is named gini_missing
ggplot(gini_na_year, aes(x = date, y = na_pct_year)) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = gini_na_year$date) +
  labs(
    title = "Gini Index Missingness Rate by Year",
    subtitle = "Percent of countries without a Gini observation",
    x = "Year",
    y = "Missingness (%)"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 18),
    plot.subtitle = element_text(size = 13),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )

```

## 4. Join the tables
```{r}
master_table <- fao_data_c_w_ssr %>%
  left_join(gini_data, by = c("ISO3" = "iso3c"))
master_table
```
## 5. Check for NAs 
```{r}
# Missingness by (year) for years 2000-2023
master_table %>%
  summarise(
    na_ct_year_g   = sum(is.na(master_table$Gini_Index)),
    total_n_year_g = n(),                      # group-specific N
    na_pct_year_g  = na_ct_year_g / total_n_year_g * 100,
    sample_n_year_g = n() - na_ct_year_g,
    na_ct_year_s   = sum(is.na(master_table$ssr)),
    total_n_year_s = n(),                      # group-specific N
    na_pct_year_s  = na_ct_year_s / total_n_year_s * 100,
    sample_n_year_s = n() - na_ct_year_s)

master_table_clean <- 
  master_table %>%
  drop_na(Gini_Index, ssr)
```









########## RECYCLE BIN ##############
```{r}
# Remove non-countries with WB look-up table
paths_allowed("https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm")

wb_url <- read_html("https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm")

nds <- html_nodes(wb_url, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "WT1", " " ))]//p')

wb_countries <- html_text(nds)
head(wb_countries)
countries <- wb_countries %>%
  as_tibble()
```

```{r}
# 3. The "Golden Key": Create ISO3 Column for FAO Data
# FAO uses M49 codes; World Bank uses ISO3. Use `countrycode` to bridge them.
fao_data$iso3c <- countrycode(fao_data$area_code_m49, 
                              origin = "iso3n", 
                              destination = "iso3c")
```

```{r}
# 2. Fetch FAO Data (Nitrogen - Ecological Ceiling)
# Domain: 'RFN' = Fertilizers by Nutrient
nitro_data <- get_faostat_bulk(code = "RFN", date_format = "%Y") %>%
  filter(Year == 2021, 
         Item == "Nutrient nitrogen N (total)",
         Element == "Use per area of cropland") %>%
  select(area_code_m49, Nitrogen_Use = Value)
```

```{r}

  
# 3. Get World Bank Data (GDP, Life Expectancy)
# "NY.GDP.PCAP.CD" = GDP per capita
# "SP.DYN.LE00.IN" = Life Expectancy
wb_data <- wb_data(indicator = c("NY.GDP.PCAP.CD", "SP.DYN.LE00.IN"), 
                   start_date = 2021, end_date = 2021)
```