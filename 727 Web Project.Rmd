---
title: "727 Web Project"
subtitle: "Local Food Chains and Country Health Outcomes"
author: "Ellen Hickman"
date: "Fall 2025"
output: html_document
---

```{r}
library(xml2)
library(tidyverse)
library(dplyr)
library(rvest)
library(robotstxt)
library(httr)
library(jsonlite)
library(FAOSTAT) # package for FAO Data (local food chain indicator made from Self-Sufficiency inputs)
library(wbstats) # package for World Bank Data
library(countrycode) # for linking datasets
```

# 1A. Get FAO Data (Self-Sufficiency inputs)
# Domain 'FBS' = Food Balance Sheets
```{r}
fao_data <- get_faostat_bulk("FBS") 
glimpse(fao_data)
options(scipen = 999)
```

### World Bank Country Codes
```{r}
# Remove non-countries with WB look-up table
library(readr)
country_codes <- read_csv("~/Desktop/727/727 Web Project/wb_countrycodes.csv")
country_codes$Code <- sprintf("%03d", country_codes$Code)
country_codes
```

```{r}
table(fao_data$element)
table(fao_data$element_code)
area_cts = table(fao_data$area)

fao_data_c <- fao_data %>%
  mutate(
    area_code = area_code__m49_ %>%
      gsub("^'", "", .) %>%       # remove leading apostrophe
      as.integer() %>%
      sprintf("%03d", .)          # pad to 3 digits
  ) %>%
  filter(
    area_code %in% country_codes$Code,
    year == 2023,
    item == "Wheat and products",
    element %in% c("production", "import_quantity", "export_quantity")) %>%
  select(area_code, area, value, element)
fao_data_c
```
## 1B. Clean Data
```{r}
# Convert to wide format
fao_data_c_w <- pivot_wider(fao_data_c, names_from = element, values_from = value)
fao_data_c_w
```



## 1C. Food Self-Sufficiency Ratio (SSR)
# Domestic Production / Domestic Consumption
# SSR = (Production / (Production + Imports - Exports))
```{r}
# SSR > 100%: Net Exporter (Globalized Provider). The country produces more than it eats (e.g., Brazil with Soy).
# SSR < 100%: Import Dependent (Globalized Consumer). The country relies on global chains to eat (e.g., Japan, UK).
# SSR â‰ˆ 100%: Self-Sufficient (Local). The country eats what it grows (e.g., Guyana, India for certain grains).

fao_data_c_w$ssr <- fao_data_c_w$production/(fao_data_c_w$production + fao_data_c_w$import_quantity - fao_data_c_w$export_quantity)

fao_data_c_w_ssr <- fao_data_c_w %>% 
  mutate(
    ssr = round((production / (production + import_quantity - export_quantity)) * 100,2)
  )
fao_data_c_w_ssr
```
## Dependent Variables
# 2. Fetch FAO Data (Nitrogen - Ecological Ceiling)
# Domain: 'RFN' = Fertilizers by Nutrient
nitro_data <- get_faostat_bulk(code = "RFN", date_format = "%Y") %>%
  filter(Year == 2021, 
         Item == "Nutrient nitrogen N (total)",
         Element == "Use per area of cropland") %>%
  select(area_code_m49, Nitrogen_Use = Value)
  
# 3. Get World Bank Data (GDP, Life Expectancy)
# "NY.GDP.PCAP.CD" = GDP per capita
# "SP.DYN.LE00.IN" = Life Expectancy
wb_data <- wb_data(indicator = c("NY.GDP.PCAP.CD", "SP.DYN.LE00.IN"), 
                   start_date = 2021, end_date = 2021)

# 4. Fetch World Bank Data (Obesity & Gini)
degrowth_vars <- wb_data(
  indicator = c("SH.STA.OB18.MA.ZS", "SI.POV.GINI"), 
  start_date = 2021, end_date = 2021
) %>%
  select(iso3c, Obesity_Rate = SH.STA.OB18.MA.ZS, Gini_Index = SI.POV.GINI)

## 4. Join the tables
master_table <- left_join(fao_data, wb_data, by = "iso3c")

# 3. Join logic (Requires your previous Master Table)
# Note: You need to map FAO M49 to ISO3c again for the Nitrogen data
nitro_data$iso3c <- countrycode(nitro_data$area_code_m49, "iso3n", "iso3c")

final_dataset <- master_table %>%
  left_join(degrowth_vars, by = "iso3c") %>%
  left_join(nitro_data, by = "iso3c")

## 5. Check for NAs (Common in Gini/Nitrogen data)
# You may need to drop rows or impute data for the clustering to work
clean_data <- na.omit(final_dataset)












########## RECYCLE BIN ##############
```{r}
# Remove non-countries with WB look-up table
paths_allowed("https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm")

wb_url <- read_html("https://wits.worldbank.org/wits/wits/witshelp/content/codes/country_codes.htm")

nds <- html_nodes(wb_url, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "WT1", " " ))]//p')

wb_countries <- html_text(nds)
head(wb_countries)
countries <- wb_countries %>%
  as_tibble()
```

```{r}
# 3. The "Golden Key": Create ISO3 Column for FAO Data
# FAO uses M49 codes; World Bank uses ISO3. Use `countrycode` to bridge them.
fao_data$iso3c <- countrycode(fao_data$area_code_m49, 
                              origin = "iso3n", 
                              destination = "iso3c")
```